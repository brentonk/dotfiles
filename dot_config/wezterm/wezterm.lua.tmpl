-- vim: ft=lua

{{- /* Per-host window opacity */ -}}
{{- $opacity := 0.9 -}}
{{- if eq .chezmoi.hostname "milchick" -}}
{{-   $opacity = 0.95 -}}
{{- end }}
-- Pull in the wezterm API
local wezterm = require 'wezterm'

-- Hold the configuration
local config = wezterm.config_builder()

-- Fonts
config.font = wezterm.font 'JetBrainsMono Nerd Font'
config.font_size = 11.0

-- Color theme
config.color_scheme = 'Everforest Dark (Gogh)'
config.hide_tab_bar_if_only_one_tab = true

-- Opacity toggle: watch a state file so sway keybinding can trigger reload
local opacity_state = (os.getenv('XDG_RUNTIME_DIR') or '/tmp') .. '/wezterm-opacity-toggle'
do
  local f = io.open(opacity_state, 'r')
  if not f then
    f = io.open(opacity_state, 'w')
    if f then f:close() end
  else
    f:close()
  end
end
wezterm.add_to_config_reload_watch_list(opacity_state)

local function is_opaque()
  local f = io.open(opacity_state, 'r')
  if f then
    local content = f:read('*a')
    f:close()
    return content:match('opaque') ~= nil
  end
  return false
end

config.window_background_opacity = is_opaque() and 1.0 or {{ $opacity }}

-- Wayland
config.enable_wayland = true
config.use_ime = true

-- Send distinct escape sequences for modifier+key combos (CSI u / kitty encoding)
config.enable_csi_u_key_encoding = true

return config
